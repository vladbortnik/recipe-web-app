# =============================================================================
# NGINX Configuration - Load Balanced Setup with Network Segregation
# =============================================================================
#
# PURPOSE:
#   This configuration provides load balancing across multiple Flask application
#   instances for high availability and improved performance. Ideal for production
#   deployments that require fault tolerance and horizontal scaling.
#
# ARCHITECTURE:
#   Internet → Nginx (Port 80/443) → Load Balancer → Flask Apps (Ports 5002-5004)
#                                                          ↓
#                                                    PostgreSQL (Internal)
#
# LOAD BALANCING STRATEGIES:
#   - ip_hash: Same client always routes to same server (session sticky)
#   - least_conn: Routes to server with fewest active connections
#   - round_robin: Default, distributes requests evenly (remove ip_hash line)
#
# PREREQUISITES:
#   1. SSL certificates (e.g., from Let's Encrypt)
#   2. Docker Compose running with load balancer setup
#      (compose-w-Load-Balancer-n-Network-Segregation.yaml)
#   3. DNS A record pointing to your server IP
#
# USAGE:
#   1. Copy this file to /etc/nginx/sites-available/your-domain.conf
#   2. Update 'server_name' with your actual domain
#   3. Update SSL certificate paths
#   4. Verify upstream ports match your docker-compose.yaml
#   5. Create symlink: ln -s /etc/nginx/sites-available/your-domain.conf /etc/nginx/sites-enabled/
#   6. Test config: nginx -t
#   7. Reload nginx: systemctl reload nginx
#
# RELATED FILES:
#   - docker-compose-examples/compose-w-Load-Balancer-n-Network-Segregation.yaml
#
# =============================================================================

# -----------------------------------------------------------------------------
# Upstream Configuration - Load Balancer Pool
# -----------------------------------------------------------------------------
# Defines the backend servers that will receive proxied requests.
# Ports MUST match the host ports in your docker-compose.yaml file.
upstream recipe_app {
    # Load Balancing Strategy: ip_hash ensures session persistence
    # (same client IP always routes to the same backend server)
    # Remove this line for round-robin distribution
    ip_hash;
    
    # Backend servers with health check parameters
    # max_fails: Number of failed attempts before marking server as unavailable
    # fail_timeout: Time to wait before retrying a failed server
    server 127.0.0.1:5002 max_fails=3 fail_timeout=30s;   # web1 container
    server 127.0.0.1:5003 max_fails=3 fail_timeout=30s;   # web2 container
    server 127.0.0.1:5004 max_fails=3 fail_timeout=30s;   # web3 container
    
    # Keepalive connections to upstream servers (improves performance)
    keepalive 32;
}

# -----------------------------------------------------------------------------
# Logging Configuration (Optional - Uncomment for debugging)
# -----------------------------------------------------------------------------
# Detailed logging format that includes upstream timing information
# Useful for debugging load balancing issues and performance analysis
#
# log_format upstream_time '$remote_addr - $remote_user [$time_local] '
#                          '"$request" $status $body_bytes_sent '
#                          '"$http_referer" "$http_user_agent" '
#                          'rt=$request_time uct="$upstream_connect_time" '
#                          'uht="$upstream_header_time" urt="$upstream_response_time" '
#                          'upstream_addr="$upstream_addr"';

# -----------------------------------------------------------------------------
# HTTP Server Block - Redirect all HTTP traffic to HTTPS
# -----------------------------------------------------------------------------
server {
    listen 80;
    # listen [::]:80;                           # Uncomment for IPv6 support

    server_name recipe.vladbortnik.dev;         # CHANGE: Replace with your domain

    # Uncomment for detailed logging during debugging
    # access_log /var/log/nginx/recipe_access.log upstream_time;
    # error_log /var/log/nginx/recipe_error.log debug;

    # Redirect all HTTP requests to HTTPS (301 = permanent redirect)
    location / {
        return 301 https://$host$request_uri;
    }
}

# -----------------------------------------------------------------------------
# HTTPS Server Block - Main Application Server with Load Balancing
# -----------------------------------------------------------------------------
server {
    listen 443 ssl http2;
    # listen [::]:443 ssl http2;                # Uncomment for IPv6 support

    server_name recipe.vladbortnik.dev;         # CHANGE: Replace with your domain

    # Uncomment for detailed logging during debugging
    # access_log /var/log/nginx/recipe_access.log upstream_time;
    # error_log /var/log/nginx/recipe_error.log debug;

    # -------------------------------------------------------------------------
    # SSL/TLS Configuration
    # -------------------------------------------------------------------------
    # Certificate paths - update these to your actual certificate locations
    # For Let's Encrypt: /etc/letsencrypt/live/your-domain/
    ssl_certificate /etc/letsencrypt/live/recipe.vladbortnik.dev/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/recipe.vladbortnik.dev/privkey.pem;
    
    # SSL Session Settings (improves performance by caching SSL sessions)
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;        # ~40,000 sessions
    ssl_session_tickets off;                    # Disable for better security

    # Modern SSL Configuration (TLS 1.3 only - most secure)
    # Note: Use TLSv1.2 TLSv1.3 if you need to support older browsers
    ssl_protocols TLSv1.3;
    ssl_prefer_server_ciphers off;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    # HSTS - Force HTTPS for 2 years (recommended after testing)
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # Prevent clickjacking attacks
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME-type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Restrict browser features
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

    # Content Security Policy (CSP) - Adjust based on your application's needs
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://www.google.com https://www.gstatic.com https://analytics.vladbortnik.dev; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com https://unpkg.com; img-src 'self' data: blob: https://images.pexels.com https://i.pravatar.cc https://spoonacular.com https://*.spoonacular.com; font-src 'self' data: https://fonts.gstatic.com https://cdnjs.cloudflare.com; frame-src https://www.google.com; connect-src 'self' https://analytics.vladbortnik.dev;" always;

    # -------------------------------------------------------------------------
    # OCSP Stapling (Optional - improves SSL handshake performance)
    # -------------------------------------------------------------------------
    # Uncomment if your CA supports OCSP stapling
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # ssl_trusted_certificate /etc/letsencrypt/live/recipe.vladbortnik.dev/chain.pem;
    # resolver 8.8.8.8 8.8.4.4 valid=300s;      # Google DNS
    # resolver_timeout 5s;

    # -------------------------------------------------------------------------
    # Reverse Proxy Configuration - Load Balanced
    # -------------------------------------------------------------------------
    location / {
        # Forward requests to upstream pool (load balanced)
        proxy_pass http://recipe_app;
        
        # For testing a single backend server, use:
        # proxy_pass http://127.0.0.1:5002;
        
        # Preserve original client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Required for keepalive connections to upstream
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        
        # Timeout settings (adjust based on your application's needs)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # -------------------------------------------------------------------------
    # Static Files Caching (improves performance)
    # -------------------------------------------------------------------------
    location /static/ {
        proxy_pass http://recipe_app;
        proxy_cache_valid 200 30d;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # -------------------------------------------------------------------------
    # Health Check Endpoint (for monitoring)
    # -------------------------------------------------------------------------
    location /health {
        proxy_pass http://recipe_app;
        proxy_set_header Host $host;
        access_log off;                         # Don't log health checks
    }
}
