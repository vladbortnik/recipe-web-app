# =============================================================================
# NGINX Configuration - Simple Setup with Auto-Migration
# =============================================================================
# 
# PURPOSE:
#   This configuration is for a single-instance Flask application deployment
#   with SSL/TLS termination. It's ideal for development or small-scale production.
#
# ARCHITECTURE:
#   Internet → Nginx (Port 80/443) → Flask App (Port 5002)
#
# PREREQUISITES:
#   1. SSL certificates (e.g., from Let's Encrypt)
#   2. Docker Compose running with the simple setup (compose-simple-w-auto-migration.yaml)
#   3. DNS A record pointing to your server IP
#
# USAGE:
#   1. Copy this file to /etc/nginx/sites-available/your-domain.conf
#   2. Update 'server_name' with your actual domain
#   3. Update SSL certificate paths
#   4. Create symlink: ln -s /etc/nginx/sites-available/your-domain.conf /etc/nginx/sites-enabled/
#   5. Test config: nginx -t
#   6. Reload nginx: systemctl reload nginx
#
# RELATED FILES:
#   - docker-compose-examples/compose-simple-w-auto-migration.yaml
#
# =============================================================================

# -----------------------------------------------------------------------------
# HTTP Server Block - Redirect all HTTP traffic to HTTPS
# -----------------------------------------------------------------------------
server {
    listen 80;
    # listen [::]:80;                           # Uncomment for IPv6 support

    server_name recipe.vladbortnik.dev;         # CHANGE: Replace with your domain

    # Redirect all HTTP requests to HTTPS (301 = permanent redirect)
    location / {
        return 301 https://$host$request_uri;
    }
}

# -----------------------------------------------------------------------------
# HTTPS Server Block - Main Application Server
# -----------------------------------------------------------------------------
server {
    listen 443 ssl http2;
    # listen [::]:443 ssl http2;                # Uncomment for IPv6 support

    server_name recipe.vladbortnik.dev;         # CHANGE: Replace with your domain

    # -------------------------------------------------------------------------
    # SSL/TLS Configuration
    # -------------------------------------------------------------------------
    # Certificate paths - update these to your actual certificate locations
    # For Let's Encrypt: /etc/letsencrypt/live/your-domain/
    ssl_certificate /etc/letsencrypt/live/recipe.vladbortnik.dev/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/recipe.vladbortnik.dev/privkey.pem;
    
    # SSL Session Settings (improves performance by caching SSL sessions)
    ssl_session_timeout 1d;
    ssl_session_cache shared:MozSSL:10m;        # ~40,000 sessions
    ssl_session_tickets off;                    # Disable for better security

    # Modern SSL Configuration (TLS 1.3 only - most secure)
    # Note: Use TLSv1.2 TLSv1.3 if you need to support older browsers
    ssl_protocols TLSv1.3;
    ssl_prefer_server_ciphers off;

    # -------------------------------------------------------------------------
    # Security Headers
    # -------------------------------------------------------------------------
    # HSTS - Force HTTPS for 2 years (recommended after testing)
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # Prevent clickjacking attacks
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Prevent MIME-type sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Control referrer information
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Restrict browser features (camera, microphone, etc.)
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()" always;

    # Content Security Policy (CSP) - Adjust based on your application's needs
    # This policy allows:
    #   - Scripts from self, inline, CDNs (Bootstrap, AOS, Cookie Consent)
    #   - Styles from self, inline, CDNs (Bootstrap, Font Awesome, Google Fonts)
    #   - Images from self, data URIs, and external sources (Pexels, Pravatar)
    #   - Fonts from self, Google Fonts, and data URIs
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://www.google.com https://www.gstatic.com https://analytics.vladbortnik.dev; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://fonts.googleapis.com https://unpkg.com; img-src 'self' data: blob: https://images.pexels.com https://i.pravatar.cc https://spoonacular.com https://*.spoonacular.com; font-src 'self' data: https://fonts.gstatic.com https://cdnjs.cloudflare.com; frame-src https://www.google.com; connect-src 'self' https://analytics.vladbortnik.dev;" always;

    # -------------------------------------------------------------------------
    # OCSP Stapling (Optional - improves SSL handshake performance)
    # -------------------------------------------------------------------------
    # Uncomment if your CA supports OCSP stapling
    # ssl_stapling on;
    # ssl_stapling_verify on;
    # ssl_trusted_certificate /etc/letsencrypt/live/recipe.vladbortnik.dev/chain.pem;
    # resolver 8.8.8.8 8.8.4.4 valid=300s;      # Google DNS
    # resolver_timeout 5s;

    # -------------------------------------------------------------------------
    # Reverse Proxy Configuration
    # -------------------------------------------------------------------------
    location / {
        # Forward requests to Flask application running on port 5002
        proxy_pass http://127.0.0.1:5002;
        
        # Preserve original client information
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeout settings (adjust based on your application's needs)
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Disable buffering for real-time applications (optional)
        # proxy_buffering off;
    }

    # -------------------------------------------------------------------------
    # Static Files Caching (Optional - improves performance)
    # -------------------------------------------------------------------------
    location /static/ {
        proxy_pass http://127.0.0.1:5002;
        proxy_cache_valid 200 30d;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # -------------------------------------------------------------------------
    # Health Check Endpoint (for monitoring)
    # -------------------------------------------------------------------------
    location /health {
        proxy_pass http://127.0.0.1:5002;
        proxy_set_header Host $host;
        access_log off;                         # Don't log health checks
    }
}
